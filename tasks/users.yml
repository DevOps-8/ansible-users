---
- name: users | creating user accounts
  user:
    comment: "{{ item.comment|default(omit) }}"
    expires: "{{ item.expires|default(omit) }}"
    generate_ssh_key: "{{ item.generate_keys|default(omit) }}"
    home: "{{ item.home|default(omit) }}"
    name: "{{ item.user }}"
    password: "{{ item.pass|default(omit) }}"
    shell: "{{ item.shell|default(omit) }}"
    state: "{{ item.state }}"
    system: "{{ item.system_account|default(omit) }}"
  with_items: '{{ create_users }}'

- name: users | adding users to sudoers
  lineinfile:
    dest: "/etc/sudoers"
    regexp: '^{{ item.user }} ALL'
    line: '{{ item.user }} ALL=(ALL) NOPASSWD:ALL'
    validate: 'visudo -cf %s'
    state: present
  with_items: '{{ create_users }}'
  when: item.sudo

- name: users | removing users from sudoers
  lineinfile:
    dest: "/etc/sudoers"
    regexp: '^{{ item.user }} ALL'
    line: '{{ item.user }} ALL=(ALL) NOPASSWD:ALL'
    validate: 'visudo -cf %s'
    state: absent
  with_items: '{{ create_users }}'
  when: not item.sudo
